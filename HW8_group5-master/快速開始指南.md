# 🔍 不相關搜尋詞檢測系統 - 快速開始指南

## 📋 內容總覽

本指南說明如何使用系統的**不相關搜尋詞檢測與處理機制**，該機制會在使用者搜尋不相關詞彙（如「星巴克」、「鋼鐵」）時提供友善的提示和建議。

---

## 🎯 核心特性

### 1. **自動檢測不相關詞彙**
- 當使用者搜尋「鋼鐵」、「星巴克」等不相關詞彙時，系統會自動識別
- 檢測機制包括：
  - 明顯不相關詞彙檢查
  - 咖啡廳領域詞彙驗證
  - 模糊匹配 (Levenshtein 距離)

### 2. **友善的使用者界面**
- 顯示黃色警告框，說明為什麼詞彙不相關
- 提供視覺清晰的建議詞彙快速搜尋按鈕
- 允許使用者選擇「仍要搜尋」來忽略警告

### 3. **智能建議系統**
- 自動提取系統中最相關的 5 個高權重關鍵字
- 建議詞彙優先來自 Tier 1 (核心詞彙) 類別
- 使用者可一鍵點擊執行建議搜尋

### 4. **靈活的搜尋選項**
- 強制搜尋：忽略警告繼續搜尋不相關詞彙
- 使用建議：快速轉換為相關詞彙搜尋
- 清除搜尋：返回首頁推薦列表

---

## 🚀 使用流程

### 流程圖
```
使用者輸入搜尋詞
        ↓
執行相關性檢查
        ↓
  ┌─────┴─────┐
  │           │
相關 ✅      不相關 ❌
  │           │
執行搜尋    顯示警告框
  │       ┌─────┬─────┐
  │       │     │     │
  ↓     仍要  使用   清除
顯示結果  搜尋 建議  搜尋
        ↓     ↓     ↓
      執行  新搜尋  返回
      搜尋  (相關詞) 首頁
```

---

## 📝 實際範例

### 範例 1: 搜尋「鋼鐵」（不相關）

**步驟 1**: 使用者輸入「鋼鐵」並點擊搜尋

**步驟 2**: 系統顯示警告
```
⚠️ 搜尋詞可能不相關

搜尋詞 "鋼鐵" 與咖啡廳相關資訊無關。

建議搜尋:
[不限時] [安靜] [咖啡] [插座] [WIFI]

[仍要搜尋] [清除搜尋]
```

**步驟 3**: 使用者選項
- 選項 A: 點擊「不限時」 → 執行新搜尋，返回 25 間咖啡廳
- 選項 B: 點擊「仍要搜尋」 → 搜尋「鋼鐵」，返回空結果
- 選項 C: 點擊「清除搜尋」 → 返回首頁推薦

### 範例 2: 搜尋「不限時」（相關）

**步驟 1**: 使用者輸入「不限時」並點擊搜尋

**步驟 2**: 系統直接執行搜尋，無任何警告

**結果**: 立即顯示 25 間符合「不限時」特性的咖啡廳

### 範例 3: 搜尋「星巴克」（不相關品牌）

**步驟 1**: 使用者輸入「星巴克」並點擊搜尋

**步驟 2**: 系統判定為品牌名稱，不是具體咖啡廳特性，顯示警告

**建議詞彙**: 不限時、安靜、咖啡、插座、WIFI

**步驟 3**: 使用者點擊「咖啡」 → 搜尋所有與咖啡相關的廳

---

## 🔧 技術架構

### 後端服務 (Java Spring Boot)

#### RelevanceValidator 服務
```
位置: src/main/java/.../service/RelevanceValidator.java

核心方法:
├─ validateRelevance(String)         : 驗證詞彙相關性
├─ isExplicitlyIrrelevant(String)    : 檢查明顯不相關詞彙
├─ isCoffeeDomainRelevant(String)    : 檢查領域相關性
├─ findSimilarKeywords(String)       : 尋找相似詞彙
└─ calculateLevenshteinDistance()    : 編輯距離計算
```

#### API 端點

1. **基本搜尋 API** (改進版)
   ```
   GET /api/search?q=不限時
   
   回應:
   {
     "success": true,
     "keyword": "不限時",
     "relevance": true,
     "message": "相關搜尋詞",
     "total": 25,
     "results": [...]
   }
   ```

2. **相關性驗證 API** (新增)
   ```
   GET /api/search/validate?q=星巴克
   
   回應:
   {
     "success": true,
     "keyword": "星巴克",
     "isRelevant": false,
     "message": "搜尋詞可能不相關，無法找到相關咖啡廳",
     "suggestions": ["不限時", "安靜", "咖啡", "插座", "WIFI"]
   }
   ```

### 前端實現 (JavaScript)

#### 搜尋模組增強功能
```javascript
// 新增函數:
checkSearchRelevance(query)     // 檢查相關性
showRelevanceWarning(...)       // 顯示警告
forceSearch(query)              // 強制搜尋
suggestSearch(suggestion)       // 使用建議詞彙搜尋
```

---

## 🎨 警告框 UI 設計

```html
┌─────────────────────────────────────────────┐
│ ⚠️ 搜尋詞可能不相關                           │
│                                              │
│ 搜尋詞 "鋼鐵" 與咖啡廳相關資訊無關。        │
│                                              │
│ 建議搜尋:                                    │
│ [不限時] [安靜] [咖啡] [插座] [WIFI]        │
│                                              │
│ [仍要搜尋] [清除搜尋]                        │
└─────────────────────────────────────────────┘
```

---

## 📊 詞彙分類

### 預設不相關詞彙 (60+ 個)

**商品與產業**:
- 鋼鐵、汽車、電子產品、電腦、手機、機械、科技

**品牌名稱**:
- 星巴克、便利店、超市、百貨、百貨公司

**其他領域**:
- 醫院、銀行、飛機、運動、股票、遊戲等

### 預設相關詞彙 (50+ 個)

**飲品**:
- 咖啡、咖啡廳、咖啡館、咖啡店、拿鐵、卡布奇諾

**功能**:
- 不限時、插座、WIFI、無線網路、充電、安靜、舒適

**用途**:
- 讀書、工作、自修、自習、下午茶、早午餐

**地區**:
- 台北、新竹、台中、高雄、台南、花蓮等

---

## ⚙️ 自訂配置

### 添加新的不相關詞彙

編輯文件: `RelevanceValidator.java`

```java
private static final Set<String> IRRELEVANT_KEYWORDS = new HashSet<>(Arrays.asList(
    // 現有詞彙...
    "新詞",      // 添加新詞彙
    "新詞2"      // 添加新詞彙
));
```

### 添加新的相關詞彙

```java
private static final Set<String> COFFEE_DOMAIN_KEYWORDS = new HashSet<>(Arrays.asList(
    // 現有詞彙...
    "新詞",      // 添加新詞彙
    "新詞2"      // 添加新詞彙
));
```

### 調整相似詞彙的距離閾值

在 `findSimilarKeywords()` 方法中修改距離值:
```java
// 當前設置: 距離 ≤ 2 視為相似
if (calculateLevenshteinDistance(term, kwTerm) <= 2) {
    // 修改 2 為其他數值，例如 3 (更寬鬆) 或 1 (更嚴格)
}
```

---

## 🧪 測試方法

### 使用 cURL 測試 API

```bash
# 測試不相關詞彙
curl "http://localhost:8080/api/search?q=鋼鐵"

# 測試相關詞彙
curl "http://localhost:8080/api/search?q=不限時"

# 單獨測試相關性驗證
curl "http://localhost:8080/api/search/validate?q=星巴克"
```

### 執行單元測試

```bash
# 在項目根目錄執行
./mvnw test -Dtest=RelevanceValidatorTest
```

---

## 📱 前端整合點

### 搜尋表單 HTML
```html
<div class="search-bar">
    <input type="text" id="searchInput" placeholder="搜尋咖啡廳...">
    <button id="searchBtn">搜尋</button>
    <button id="clearSearch" style="display:none;">✕</button>
</div>

<div id="resultsSection" style="display:none;">
    <h2 id="resultsTitle">搜尋結果</h2>
    <div id="resultsContainer"></div>
</div>
```

### JavaScript 初始化
```javascript
// search.js 會自動初始化
document.addEventListener('DOMContentLoaded', () => {
    window.searchModule.init();  // 初始化搜尋模組
});
```

---

## 🔐 安全考量

1. **輸入驗證**: 所有搜尋詞都經過長度和特殊字符驗證
2. **XSS 防護**: 建議詞彙在 HTML 中進行轉義
3. **SQL 注入防護**: 使用 Spring Data 參數化查詢
4. **速率限制**: 可配置 API 請求頻率限制

---

## 📈 性能優化

1. **緩存機制**: 相關性結果可被前端緩存
2. **異步檢查**: 相關性檢查不阻塞搜尋輸入
3. **優雅降級**: 檢查失敗時默認允許搜尋

---

## ❓ 常見問題

**Q: 為什麼我的搜尋詞被標記為不相關？**
A: 系統檢查詞彙是否與咖啡廳特性、地區或服務相關。如果詞彙無關（如「鋼鐵」），系統會提示。

**Q: 我可以忽略警告繼續搜尋嗎？**
A: 可以！點擊「仍要搜尋」按鈕來執行搜尋，但可能返回空結果。

**Q: 建議詞彙是怎麼生成的？**
A: 系統自動提取 `keywords.json` 中權重最高的 Tier 1 關鍵字。

**Q: 如何添加自己的不相關詞彙？**
A: 編輯 `RelevanceValidator.java` 中的 `IRRELEVANT_KEYWORDS` 集合。

**Q: 為什麼某個詞彙不被識別為相關？**
A: 可能需要添加到 `COFFEE_DOMAIN_KEYWORDS` 或確保 `keywords.json` 已正確載入。

---

## 🚀 部署檢查清單

- [ ] 編譯無錯誤: `mvnw clean compile`
- [ ] 所有測試通過: `mvnw test`
- [ ] 後端 API 可訪問: 檢查 `/api/search/validate` 端點
- [ ] 前端警告框顯示正確
- [ ] 建議詞彙按鈕可點擊
- [ ] 強制搜尋功能可用
- [ ] 日誌無異常錯誤

---

## 📞 支持與反饋

如有任何問題或建議，請檢查：
1. 後端日誌（SearchController, RelevanceValidator）
2. 前端控制台 (F12 開發者工具)
3. API 回應狀態碼和錯誤信息

---

## 📚 相關文件

- 完整技術文檔: `不相關搜尋詞處理說明.md`
- 單元測試: `RelevanceValidatorTest.java`
- 後端實現: `RelevanceValidator.java`
- 前端實現: `search.js`
- API 文檔: `/api/search/validate`

---

## 🎉 總結

此系統提供了一個完整的不相關搜尋詞檢測和處理方案，包括：
- ✅ 自動檢測
- ✅ 友善提示
- ✅ 智能建議
- ✅ 靈活選項

讓使用者在搜尋「星巴克」、「鋼鐵」等詞彙時，獲得更好的體驗和引導！
