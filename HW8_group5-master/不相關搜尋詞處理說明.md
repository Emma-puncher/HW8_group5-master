# 不相關搜尋詞檢測與處理機制

## 功能概述
系統現在能夠檢測和處理不相關的搜尋詞彙（例如：「星巴克」、「鋼鐵」等），並為使用者提供友善的提示和建議。

---

## 核心實現

### 1. 後端服務：RelevanceValidator
**文件位置**: `src/main/java/com/example/GoogleQuery/service/RelevanceValidator.java`

#### 主要功能：
- **檢測明顯不相關詞彙**: 包含品牌名稱、不相關產業等
- **領域詞彙匹配**: 檢查是否與咖啡廳、讀書、工作相關
- **模糊匹配**: 使用編輯距離算法尋找相似關鍵字
- **生成建議**: 提供與咖啡廳領域相關的高權重關鍵字建議

#### 預定義的不相關詞彙範例：
- **品牌名稱**: 星巴克、便利店、超市
- **商品類別**: 鋼鐵、汽車、電子產品、機械
- **其他領域**: 醫院、銀行、飛機、股票、運動、遊戲等

#### 預定義的相關詞彙：
- **飲品**: 咖啡、濃縮、美式、拿鐵、卡布奇諾等
- **功能**: 不限時、插座、WIFI、安靜、舒適
- **用途**: 讀書、工作、自修、下午茶
- **地區**: 台北、新竹、台中等

---

### 2. 後端 API 端點

#### ✅ 基本搜尋 API (改進版)
```
GET /api/search?q=不限時
```

**回應範例 (相關詞彙)**:
```json
{
  "success": true,
  "keyword": "不限時",
  "relevance": true,
  "message": "相關搜尋詞",
  "total": 25,
  "results": [...]
}
```

**回應範例 (不相關詞彙)**:
```json
{
  "success": true,
  "keyword": "鋼鐵",
  "relevance": false,
  "warning": true,
  "message": "搜尋詞與咖啡廳相關資訊無關",
  "suggestions": ["不限時", "安靜", "咖啡", "插座", "WIFI"],
  "results": [],
  "total": 0
}
```

#### 🆕 相關性驗證 API
```
GET /api/search/validate?q=星巴克
```

**功能**: 單純檢查搜尋詞的相關性，不執行搜尋

**回應範例**:
```json
{
  "success": true,
  "keyword": "星巴克",
  "isRelevant": false,
  "message": "搜尋詞可能不相關，無法找到相關咖啡廳",
  "suggestions": ["不限時", "安靜", "咖啡", "插座", "WIFI"]
}
```

---

### 3. 前端實現

#### 檔案位置: `src/main/resources/static/js/search.js`

#### 主要改進：
1. **搜尋前檢查**: 執行搜尋前先驗證詞彙相關性
2. **友善提示**: 顯示視覺化的警告框，說明原因
3. **建議詞彙**: 提供快速搜尋按鈕，使用建議的相關詞彙
4. **強制搜尋**: 使用者可選擇忽略警告，繼續搜尋不相關詞彙

#### 前端流程：
```javascript
// 1. 使用者輸入搜尋詞
// 2. 執行 checkSearchRelevance(query)
// 3. 如果不相關，顯示 showRelevanceWarning(query, result)
// 4. 使用者可選擇：
//    - 仍要搜尋 -> forceSearch(query)
//    - 使用建議詞 -> suggestSearch(suggestion)
//    - 清除搜尋 -> clear()
```

---

## 使用範例

### 場景 1: 搜尋不相關詞彙「鋼鐵」

1. 使用者在搜尋框輸入「鋼鐵」
2. 點擊搜尋或按 Enter
3. 系統顯示警告框：
   - ⚠️ 搜尋詞可能不相關
   - 原因說明
   - 建議詞彙（不限時、安靜、咖啡等）
4. 使用者可選擇：
   - 點擊「仍要搜尋」繼續（返回空結果）
   - 點擊建議詞彙進行新搜尋
   - 點擊「清除搜尋」返回推薦頁面

### 場景 2: 搜尋相關詞彙「不限時」

1. 使用者輸入「不限時」
2. 系統直接執行搜尋，顯示結果
3. 無任何警告或延遲

### 場景 3: 搜尋部分相關詞彙「星巴克」

1. 搜尋「星巴克」（咖啡品牌）
2. 系統判定為不相關（非具體咖啡廳）
3. 提示建議相關搜尋詞

---

## 自訂不相關詞彙

要添加更多不相關詞彙，編輯 `RelevanceValidator.java`:

```java
private static final Set<String> IRRELEVANT_KEYWORDS = new HashSet<>(Arrays.asList(
    "鋼鐵", "汽車", "電子產品",  // 現有的
    "新詞", "新詞2"                // 添加新詞彙
));
```

## 自訂相關詞彙

編輯 `RelevanceValidator.java`:

```java
private static final Set<String> COFFEE_DOMAIN_KEYWORDS = new HashSet<>(Arrays.asList(
    "咖啡", "不限時", "插座",    // 現有的
    "新詞", "新詞2"               // 添加新詞彙
));
```

---

## API 測試命令

### 測試基本搜尋（不相關詞）
```bash
curl "http://localhost:8080/api/search?q=鋼鐵"
```

### 測試相關性驗證
```bash
curl "http://localhost:8080/api/search/validate?q=星巴克"
```

### 測試基本搜尋（相關詞）
```bash
curl "http://localhost:8080/api/search?q=不限時"
```

---

## 技術細節

### 編輯距離算法 (Levenshtein Distance)
用於模糊匹配，找出與搜尋詞相似的有效關鍵字
- 距離 ≤ 2: 視為相似詞彙
- 例如: 「便利店」與「便利超」的距離為 1

### 層級關鍵字系統
系統自動從 `keywords.json` 載入分級關鍵字：
- **Tier 1 (核心詞)**: 權重最高，如「不限時」、「插座」
- **Tier 2 (次要詞)**: 權重中等
- **Tier 3 (相關詞)**: 權重較低

建議優先使用 Tier 1 關鍵字

---

## 故障排查

### 問題 1: 相關詞彙被誤判為不相關
**解決方案**: 在 `COFFEE_DOMAIN_KEYWORDS` 中添加該詞彙

### 問題 2: 相關性檢查失敗，無法搜尋
**解決方案**: 系統會自動降級，允許搜尋繼續（預設為相關）

### 問題 3: 建議詞彙列表為空
**解決方案**: 確保 `keywords.json` 已正確載入，檢查 `KeywordService` 初始化

---

## 未來改進建議

1. **機器學習**: 使用 NLP 模型進行更精確的相關性判斷
2. **使用者反饋**: 記錄使用者選擇「仍要搜尋」的詞彙，優化判斷邏輯
3. **多語言支援**: 擴展對其他語言的詞彙檢測
4. **個性化建議**: 根據使用者搜尋歷史提供更相關的建議
5. **搜尋詞校正**: 自動糾正常見打字錯誤

---

## 總結

這個不相關搜尋詞處理機制提供：
- ✅ 自動檢測不相關搜尋詞
- ✅ 友善的使用者界面提示
- ✅ 智能建議機制
- ✅ 靈活的強制搜尋選項
- ✅ 易於自訂的詞彙列表

使用者在搜尋「星巴克」、「鋼鐵」等不相關詞彙時，系統會友善提示並引導他們使用相關詞彙進行搜尋！
